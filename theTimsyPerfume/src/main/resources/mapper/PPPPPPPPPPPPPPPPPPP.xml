<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productMapperPR">
	
	<resultMap id="productSelectResultSet" type="productSelect">
		<result column="PDT_NO" property="pdtNo" />
		<result column="PDT_NAME" property="pdtName" />
		<result column="PDT_INTRO" property="pdtIntro" />
		<result column="PDT_DESCRIPTION" property="pdtDescription" />
		<result column="PDT_SHIPPING" property="pdtShipping" />
		<result column="PDT_COUNT" property="pdtCount" />
		<result column="PDT_CATEG_NO" property="pdtCategNo" />
		<result column="PDT_CTEG" property="pdtCteg" />
		<result column="PDT_MANUFAC" property="pdtManufac" />
		<result column="PDT_GROUP" property="pdtGroup" />
		<result column="PDT_FILE_NO" property="pdtFileNo" />
		<result column="PDT_FILE_INDEX" property="pdtFileIndex" />
		<result column="PDT_IMG_SRC" property="pdtImgSrc" />
		<result column="REVIEW_AVG" property="reviewAvg" />
	</resultMap>
	
	<resultMap id="cartResultSet" type="cart">
		<result column="CART_NO" property="cartNo" />
		<result column="USER_NO" property="userNo" />
		<result column="PDT_NO" property="pdtNo" />
		<result column="PDT_OPTION_NO" property="pdtOptionNo" />
		<result column="CART_QUANTITY" property="cartQuantity" />
	</resultMap>
	
	<resultMap id="productOptionResultSet" type="productOption">
		<result column="PDT_OPTION_NO" property="pdtOptionNo" />
		<result column="PDT_NO" property="pdtNo" />
		<result column="PDT_OPTION_FIRST" property="pdtOptionFirst" />
		<result column="PDT_OPTION_PRICE" property="pdtOptionPrice" />
		<result column="PDT_OPTION_STOCK" property="pdtOptionStock" />
	</resultMap>
	
	
	

	<!-- 브랜드 주류/향수 상품 메인보기(6개조회) & 전체보기(12개조회)를 위한 쿼리문 -->
	<select id="productSelectList" parameterType="map" resultMap="productSelectResultSet">
	
	
		  ... 생략 ...
  		  LEFT
  		  JOIN
  		  	   (
  		  	   SELECT 
  		  	   		  PDT_NO,
  		  	   		  NVL(TRUNC(AVG(REVIEW_SCORE), 2),0) "REVIEW_AVG"
  		  	   		  <if test="sort eq 'BestSeller'">
  		  	   		  ,
  		  	   		  NVL(SUM(ORDER_QUANTITY), 0) "TOTAL_SALES",
      				  TRUNC(AVG(NVL(PAY_TOTAL, 0) + NVL(PAY_ADJUST, 0))) "SALES_AVG"
  		  	   		  </if>
  		  			  <if test="sort eq 'Popular'">
  		  	   		  ,
  		  	   		  NVL(SUM(W.USER_NO), 0) "TOTAL_WISH"
  		  	   		  </if>
				 FROM
				 	   상품, 옵션, 리뷰 테이블 조인

		  ... 생략 ...		 
		  		
				... 동적 SQL ...
				<if test="sort eq 'BestSeller'">
				 LEFT
				 JOIN
				 	  TB_ORDER_PRODUCT USING(PDT_OPTION_NO)
                 JOIN
                 
                 	  TB_ORDER_DETAIL USING(ORDER_DETAIL_NO)
                 JOIN
                 	  TB_PAY USING(PAY_NO)
				</if>
				<if test="sort eq 'Popular'">
				 LEFT
 				 JOIN
 				 	  TB_WISHLIST W USING(PDT_NO)
				</if>
				WHERE
				<if test="sort eq 'BestSeller'">
				 	  PAY_STATUS = 'Y'
				   OR
      				  PAY_STATUS IS NULL
               	  AND
				</if>
				... 생략 ...
	
			   
			   
			   
	</select>
	
	
	<!--222
		<select id="productSelectList" parameterType="map" resultMap="productSelectResultSet">
		SELECT
			   ... 생략 ...
			   PDT_FILE_PATH || '/' || PDT_FILE_UPLOAD "PDT_IMG_SRC",
			   TO_CHAR(NVL(REVIEW_AVG, 0), 'FM0.0') "REVIEW_AVG"
		  FROM
		  	   TB_PRODUCT
		  JOIN
		  	   TB_PRODUCT_CATEGORY USING(PDT_CATEG_NO)
  		  JOIN
  		  	   TB_PRODUCT_FILE USING(PDT_NO)
  		  LEFT
  		  JOIN
  		  	   (
  		  	   SELECT 
  		  	   		  PDT_NO,
  		  	   		  AVG(REVIEW_SCORE) "REVIEW_AVG"
  		  	   		  <if test="sort eq 'BestSeller'">
  		  	   		  ,
  		  	   		  NVL(SUM(ORDER_QUANTITY), 0) "TOTAL_SALES",
      				  TRUNC(AVG(NVL(PAY_TOTAL, 0) + NVL(PAY_ADJUST, 0))) "SALES_AVG"
  		  	   		  </if>
  		  			  <if test="sort eq 'Popular'">
  		  	   		  ,
  		  	   		  NVL(SUM(W.USER_NO), 0) "TOTAL_WISH"
  		  	   		  </if>
				 FROM
				 	  TB_PRODUCT
				 JOIN
				 	  TB_PRODUCT_OPTION USING(PDT_NO)
				 LEFT
				 JOIN TB_REVIEW USING(PDT_OPTION_NO)
				 <if test="sort eq 'BestSeller'">
				 LEFT
				 JOIN
				 	  TB_ORDER_PRODUCT USING(PDT_OPTION_NO)
                 JOIN
                 
                 	  TB_ORDER_DETAIL USING(ORDER_DETAIL_NO)
                 JOIN
                 	  TB_PAY USING(PAY_NO)
				 </if>
				 <if test="sort eq 'Popular'">
				 LEFT
 				 JOIN
 				 	  TB_WISHLIST W USING(PDT_NO)
				 </if>
				WHERE
				<if test="sort eq 'BestSeller'">
				 	  PAY_STATUS = 'Y'
				   OR
      				  PAY_STATUS IS NULL
               	  AND
				</if>
					  REVIEW_STATE = 'Y'
				   OR
				   	  REVIEW_STATE IS NULL
				GROUP
				   BY
				   	  PDT_NO
			   ) USING(PDT_NO)
		 WHERE
			   PDT_CTEG = #{pdtCteg}
		   AND
		   	   PDT_FAMILY = 'B'
   		   AND
   		   	   PDT_STATUS = 'Y'
   		   AND
   		   	   PDT_FILE_INDEX = 0
		 ORDER
		    BY
			   <if test="sort eq 'BestSeller'">
			   TOTAL_SALES DESC,
			   SALES_AVG DESC,
			   </if>
			   <if test="sort eq 'Popular'">
			   TOTAL_WISH DESC,
			   </if>
			   PDT_NO DESC
	</select>
	
	
	
	-->
	
	

	
	
	
	
	
	
	
	
	
	
	
	
</mapper>