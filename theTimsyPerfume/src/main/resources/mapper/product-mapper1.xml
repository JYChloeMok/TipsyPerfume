<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productMapper1">
	
	<resultMap id="productSelectResultSet" type="productSelect">
		<result column="PDT_NO" property="pdtNo" />
		<result column="PDT_NAME" property="pdtName" />
		<result column="PDT_INTRO" property="pdtIntro" />
		<result column="PDT_DESCRIPTION" property="pdtDescription" />
		<result column="PDT_MANUFAC" property="pdtManufac" />
		<result column="REVIEW_AVG" property="reviewAvg" />
		<result column="PDT_IMG_SRC" property="pdtImgSrc" />
	</resultMap>
	
	
	<!-- 브랜드 주류/향수(판매중 상태Y)의 전체 개수 카운트 -->
	<select id="selectProductCount" parameterType="string" resultType="_int">
		SELECT COUNT(*)
		FROM TB_PRODUCT
		JOIN TB_PRODUCT_CATEGORY USING(PDT_CATEG_NO)
		WHERE PDT_CTEG = #{pdtCteg}
		AND PDT_FAMILY = 'B'
		AND PDT_STATUS = 'Y'
	</select>
	
	
	<!-- 브랜드 주류/향수 상품 메인보기(6개조회) & 전체보기(12개조회)를 위한 쿼리문 -->
	<!-- if로 쓴 이유 -> otherwise에 쓸 내용 없고, 이 경우 if를 쓰든 choose-when-otherwise를 쓰든 성능차이 크지 않을것, 가독성 좋은방향이 더 낫다 생각함 -->
	<select id="productSelectList" parameterType="map" resultMap="productSelectResultSet">
		SELECT
			   PDT_NO,
			   PDT_NAME,
			   PDT_INTRO,
			   PDT_DESCRIPTION,
			   PDT_MANUFAC,
			   PDT_FILE_PATH || '/' || PDT_FILE_UPLOAD "PDT_IMG_SRC",
			   REVIEW_AVG
		  FROM
		  	   TB_PRODUCT
		  JOIN
		  	   TB_PRODUCT_CATEGORY USING(PDT_CATEG_NO)
  		  JOIN
  		  	   TB_PRODUCT_FILE USING(PDT_NO)
  		  LEFT
  		  JOIN
  		  	   (
  		  	   SELECT 
  		  	   		  <if test="sort eq 'BestSeller'">
  		  	   		  NVL(SUM(ORDER_QUANTITY), 0) "TOTAL_SALES",
  		  	   		  </if>
  		  			  <if test="sort eq 'Popular'">
  		  	   		  NVL(SUM(W.USER_NO), 0) "TOTAL_WISH",
  		  	   		  </if>
  		  	   		  PDT_NO,
  		  	   		  AVG(NVL(REVIEW_SCORE, 0)) "REVIEW_AVG"
  		  	   		  
				 FROM
				 	  TB_PRODUCT
				 LEFT
				 JOIN TB_REVIEW USING(PDT_NO)
				 <if test="sort eq 'BestSeller'">
				 LEFT
                 JOIN
                 	  TB_ORDER_DETAIL USING(PDT_NO)
                 LEFT
                 JOIN
                 	  TB_PAY USING(PAY_NO)
				 </if>
				 <if test="sort eq 'Popular'">
				 LEFT
 				 JOIN TB_WISHLIST W USING(PDT_NO)
				 </if>
				WHERE
				<if test="sort eq 'BestSeller'">
				 	  PAY_STATUS = 'Y'
               	  AND
				</if>
					  REVIEW_STATE = 'Y'
				   OR
				   	  REVIEW_STATE IS NULL
				GROUP
				   BY
				   	  PDT_NO
			   ) USING(PDT_NO)
		 WHERE
			   PDT_CTEG = #{pdtCteg}
		   AND
		   	   PDT_FAMILY = 'B'
   		   AND
   		   	   PDT_STATUS = 'Y'
   		   AND
   		   	   PDT_FILE_INDEX = 0
		 ORDER
		    BY
			<if test="sort eq 'BestSeller'">
			   TOTAL_SALES DESC,
			</if>
			<if test="sort eq 'Popular'">
			   TOTAL_WISH DESC,
			</if>
			   PDT_NO DESC
	</select>
	
	
	<!-- 특정 유저가 한 상품에 위시리스트 추가한 내역이 있는지 조회(위시리스트 카운트) -->
	<select id="countWishOne" parameterType="wishlist" resultType="_int">
		SELECT
			   COUNT(1) "RESULT"
		  FROM
		  	   TB_WISHLIST
		 WHERE
		  	   PDT_NO = #{pdtNo}
		   AND
		  	   USER_NO = #{userNo}
	</select>
	
	
	<!-- 위시리스트 INSERT구문 -->
	<insert id="insertWishOne" parameterType="wishlist">
		INSERT
		  INTO
		  	   TB_WISHLIST
		  	   (
		  	   PDT_NO,
		  	   USER_NO
		  	   )
		VALUES
			   	(
			   	#{pdtNo},
			   	#{userNo}
			   	)
	</insert>
	
	<!-- 위시리스트 DELETE구문 -->
	<delete id="deleteWishOne" parameterType="wishlist">
		DELETE
			   TB_WISHLIST
		 WHERE
			   PDT_NO = #{pdtNo}
		   AND
			   USER_NO = #{userNo}
	</delete>
	
	
</mapper>